* GENERATED BY CHARMM-GUI (http://www.charmm-gui.org) v2.0 on Jan, 07. 2020. JOBID=7838663268
* PREPARE INPUT FILES FOR AMBER
* 

delete atom sele all end
open read unit 10 card name step3_pbcsetup.psf
read psf  unit 10 card
open read unit 10 card name step3_pbcsetup.crd
read coor unit 10 card

!
! keep each component separately
!

open write unit 51 card name amber/junk.str

calc nseg = ?NSEG
calc iseg = 1

label dseg
   coor stat sele iseg @iseg end
   set segid = ?selsegi

   define XXX sele .bonded. segid @segid .and. .not. segid @segid show end
   if ?seliseg .ne. 0 if ?seliseg .lt. @iseg goto nextseg
   if ?nsel .gt. 0 then
      set nbondseg = ?nsel
      set ibondseg = 1

      define XXX sele XXX .or. segid @segid end
      define DONE sele segid @segid end
      label dobond
         define TEST sele XXX .and. .not. DONE show end
         set segid2 = ?selsegi
         define XXX sele XXX .or. segid @segid2 end
         define DONE sele DONE .or. segid @segid2 end

         increase ibondseg by 1
      if ibondseg .le. @nbondseg goto dobond

      define XXX sele XXX .or. .bonded. XXX end
      if ?seliseg .lt. @iseg goto nextseg
      set nxxx = ?nsel
      define DONE sele DONE end
      set ndone = ?nsel
      if nxxx .ne. @ndone then
         calc nbondseg = @nxxx - @ndone
         set ibondseg = 1
         goto dobond
      endif
   else
      define XXX sele XXX .or. segid @segid end
   endif

   bomlev -1
   delete atom sele .not. XXX end
   bomlev 0

   calc njseg = ?NSEG
   calc jseg  = 1

   label djseg
      if jseg .ne. 1 then
         coor stat sele iseg 2 end
         set segid2 = ?selsegi

         join @segid @segid2 renumber
      endif

      incr jseg by 1
   if jseg .le. @njseg goto djseg

   open write unit 10 card name amber/junk_@segid.psf
   write psf  unit 10 card
   open write unit 10 card name amber/junk_@segid.crd
   write coor unit 10 card
   write title unit 51
   * open read unit 10 card name amber/junk_@segid.psf
   * read psf  unit 10 card append
   * open read unit 10 card name amber/junk_@segid.crd
   * read coor unit 10 card append
   *
 
   delete atom sele all end

   open read unit 10 card name step3_pbcsetup.psf
   read psf  unit 10 card
 
   open read unit 10 card name step3_pbcsetup.crd
   read coor unit 10 card

   label nextseg

   incr iseg by 1

if iseg .le. @nseg goto dseg

delete atom sele all end

!
! Read components
!

stream amber/junk.str

calc xcen = @A/2
calc ycen = @B/2
calc zcen = @C/2

coor trans xdir @xcen ydir @ycen zdir @zcen

open write card unit 52 name amber/step3_charmm2amber.str

stream amber/step3_charmm2amber.prot.str

close unit 53
system "python amber/step3_charmm2amber.rest.py amber/step3_charmm2amber.rest.dat"
system "rm amber/junk*"

open write unit 10 card name amber/step3_charmm2amber.psf
write psf  unit 10 card
* CHARMM2AMBER PSF
*
close unit 10

open write unit 10 card name amber/step3_charmm2amber.oldpsf
write psf  unit 10 card oldpsf
* CHARMM2AMBER OLD PSF
*
close unit 10

open write unit 10 card name amber/step3_charmm2amber.crd
write coor unit 10 card
* CHARMM2AMBER CRD
*
close unit 10

open write unit 10 card name amber/step3_charmm2amber.pdb
write coor unit 10 pdb
* CHARMM2AMBER PDB
*
close unit 10

write title unit 52
* SET NRES    = ?nres
*

